<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Principais Perguntas</title>

    <link rel="icon" href="./img/icon.svg">
    <link rel="stylesheet" href="perguntas.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">

    <script src="https://kit.fontawesome.com/c89ded80b6.js" crossorigin="anonymous"></script>
    <script type="text/javascript" src="app.js"></script>
    <script>
        var idPerguntaModal

        function descobrirId(id) {
            return id
        }

        function validacaoForm() {
            var asterisco;

            //Verificar os campos do formulário das perguntas individualmente
            const fields = document.querySelectorAll("[required]")

            function validateField(field) {
                //Lógica para verificar se existem erros
                function verifyErrors() {
                    let foundError = false;

                    for (key in field.validity) {
                        if (field.validity[key] && !field.validity.valid) {
                            foundError = key
                        }
                    };
                    return foundError
                }

                function setCustomMessage(message) {
                    if (message) {
                        $(field).attr('placeholder', field.placeholder + message)
                    }
                }

                return function() {
                    if (verifyErrors()) {
                        field.style.border = "1px solid red"

                        if (!asterisco) {
                            setCustomMessage("*")
                            asterisco = true;
                        }
                    } else {
                        field.style.border = "1px solid rgb(0, 201, 0)"
                        setCustomMessage()
                    }
                }
            }

            function customValidation(event) {
                const field = event.target
                const validation = validateField(field)
                if (field.placeholder == "Nome" || field.placeholder == "Título da pergunta" || field.placeholder == "Descreva o problema")
                    asterisco = false;
                else asterisco = true
                validation()
            }

            for (field of fields) {
                field.addEventListener("invalid", event => {
                    //Tirar o bubble
                    event.preventDefault()

                    customValidation(event)
                })

                field.addEventListener("blur", customValidation)
            }
        }

        function addPergunta() {
            validacaoForm()

            // Verfica se o formulário está preenchido corretamente
            if (!$('#form-perguntas')[0].checkValidity()) {
                return
            }

            // Obtem os valores dos campos do formulário
            let campoNome = $("#inputNome").val()
            let campoTitulo = $("#inputTitulo").val()
            let campoTexto = $("#inputProblema").val()
            let pergunta = {
                nickname: campoNome,
                titulo_pergunta: campoTitulo,
                texto: campoTexto
            }

            insertPergunta(pergunta)

            location.reload()
        }

        function alterarPergunta() {
            validacaoForm()

            // Verfica se o formulário está preenchido corretamente
            if (!$('#form-perguntas-modal')[0].checkValidity()) {
                return
            }

            // Intercepta o click do botão Alterar
            let campoNome = $("#inputNomeModal").val()
            let campoTitulo = $("#inputTituloModal").val()
            let campoTexto = $("#inputProblemaModal").val()
            let pergunta = {
                nickname: campoNome,
                titulo_pergunta: campoTitulo,
                texto: campoTexto
            }

            updatePergunta(parseInt(idPerguntaModal), pergunta)

            location.reload()
        }

        function apagarPergunta() {
            deletePergunta(parseInt(idPerguntaModal))
            init()
        }

        function gerarModal(perguntaClickada, idPergunta) {
            idPerguntaModal = descobrirId(idPergunta)

            $(".modal-header").html("");
            $("#corpoModal").html("");

            // Gera o modal com a pergunta
            $("#tituloModal").append(`<h5 id="titulo_disc">${db.data[idPergunta - 1].titulo_pergunta}</h5>
                                        <button id="fecharModalMostrarPergunta" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>`)

            $("#corpoModal").append(`<p id="p1-pergunta">${db.data[idPergunta - 1].nickname}</p>
                                        <p id="p2-pergunta" class="p2-modal">${db.data[idPergunta - 1].texto}</p>`);
        }

        function editarModal() {
            $("#inputNomeModal").val($("#p1-pergunta").text());
            $("#inputTituloModal").val($("#titulo_disc").text());
            $("#inputProblemaModal").val($("#p2-pergunta").text());
        }

        function filtroPerguntas() {
            const inputSearch = document.querySelector('#barra-pesquisa input')
            const filterInput = document.querySelector("#search")
            const filterList = document.querySelector('#historico')
            const cleanButton = document.querySelector("#cleanButton")
            const searchButton = document.querySelector("#searchButton")
            const posts = document.querySelectorAll("#conteudo_discussao li")

            const filterResults = (results, inputValue, returnMatchedResults) => results
                .filter(result => {
                    const matchedResults = result.textContent.toLowerCase().includes(inputValue)
                    return returnMatchedResults ? matchedResults : !matchedResults
                })

            const hideResults = (results, inputValue) => {
                filterResults(results, inputValue, false)
                    .forEach(result => {
                        result.classList.remove('block')
                        result.classList.add('hidden')
                    })
            }

            const showResults = (results, inputValue) => {
                filterResults(results, inputValue, true)
                    .forEach(result => {
                        result.classList.remove('hidden')
                        result.classList.add('block')
                    })
            }

            const showPostIfMatchInputValue = inputValue => post => {
                const postTitle = post.querySelector('#tituloPergunta').textContent.toLocaleLowerCase()
                const postBody1 = post.querySelector('#p1-pergunta').textContent.toLocaleLowerCase()
                const postBody2 = post.querySelector('#p2-pergunta').textContent.toLocaleLowerCase()
                const postContainsInputValue = postTitle.includes(inputValue) ||
                    postBody1.includes(inputValue) ||
                    postBody2.includes(inputValue)

                if (postContainsInputValue) {
                    post.style.display = 'block'
                    return
                }

                post.style.display = 'none'
            }

            const cleanInput = event => {
                inputSearch.value = ""

                posts.forEach(post => {
                    post.style.display = 'block'
                })

                switchSearchIcon()
            }

            function switchSearchIcon() {
                if (inputSearch.value.length > 0) {
                    searchButton.classList.remove("block");
                    searchButton.classList.add("hidden");

                    cleanButton.classList.remove("hidden");
                    cleanButton.classList.add("block");
                } else {
                    searchButton.classList.remove("hidden");
                    searchButton.classList.add("block");

                    cleanButton.classList.remove("block");
                    cleanButton.classList.add("hidden");
                }
            }

            const handleInputValue = event => {
                const inputValue = event.target.value.trim().toLowerCase()
                const results = Array.from(filterList.children)


                posts.forEach(showPostIfMatchInputValue(inputValue))

                hideResults(results, inputValue)
                showResults(results, inputValue)

                switchSearchIcon()
            }

            filterList.addEventListener('click', event => {
                const inputValue = event.target.textContent.toLocaleLowerCase()

                posts.forEach(showPostIfMatchInputValue(inputValue))

                filterInput.value = event.target.textContent
            })

            inputSearch.addEventListener('input', handleInputValue)

            inputSearch.addEventListener('blur', switchSearchIcon())

            cleanButton.addEventListener('click', cleanInput)
        }
        const btnMobile = document.getElementById('btn-mobile')

        function toggleMenu() {
            const nav = document.getElementById("nav")

            nav.classList.toggle('active')
        }

        function init() {
            function resolveAfterXs(x) {
                return new Promise(resolve => {
                    setTimeout(() => {
                        resolve(x);
                    }, 100);
                });
            }

            //Calcula o ano
            document.querySelector('#ano').innerHTML = new Date().getFullYear()

            //Limpa todas as informações do Data Base
            $("#conteudo_discussao").html("");
            $("#historico").html("");

            // Popula a lista com os registros do banco de dados
            for (i = 0; i < db.data.length; i++) {
                let discus = db.data[i];
                $("#conteudo_discussao").append(`<li display="block" class="perguntaLinha" data-bs-target="#modal-pergunta" data-bs-toggle="modal" id="${discus.id}">
                                                    <h5 id="tituloPergunta">${discus.titulo_pergunta}</h5>           
                                                    <p id="p1-pergunta">${discus.nickname}</p>
                                                    <p id="p2-pergunta">${discus.texto}</p>
                                                    <hr>
                                                </li>`);
                $("#historico").append(`<option id="historicoPesquisa">${discus.titulo_pergunta}</option>`)
            }


            // Identifica qual pergunta clickada 
            $("#conteudo_discussao").on("click", "li", function(e) {
                let linhaPergunta = this;
                gerarModal(linhaPergunta, linhaPergunta.id)
            });

            const filterSearch = document.querySelector('#historico')
            const inputSearch = document.querySelector('#barra-pesquisa input')



            const hideResults = async event => {
                await resolveAfterXs(1);
                const results = Array.from(filterSearch.children).forEach(result => {
                    result.classList.remove('block')
                    result.classList.add('hidden')
                })
            }

            const showResults = event => {
                const results = Array.from(filterSearch.children).forEach(result => {
                    result.classList.remove('hidden')
                    result.classList.add('block')
                })
            }

            inputSearch.addEventListener('click', showResults)
            inputSearch.addEventListener('blur', hideResults)

        }
    </script>
</head>

<body onload="init()">
    <!-- Modal Adicionar Pergunta-->
    <div class="modal fade" id="adicioner-pergunta" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header-config">
                    <h5 class="modal-title" id="staticBackdropLabel">Adicionar Pergunta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body-config">
                    <form id="form-perguntas">
                        <div class="form-group row campo1">
                            <div class="col-sm-6">
                                <label for="inputNome"></label>
                                <input type="text" class="form-control" id="inputNome" placeholder="Nome" required>
                            </div>
                            <div class="col-sm-6">
                                <label for="inputTitulo"></label>
                                <input type="text" class="form-control" id="inputTitulo" placeholder="Título da pergunta" autocomplete="off" required>
                            </div>
                        </div>
                        <div class="form_group campo2">
                            <label for="inputProblema"></label>
                            <textarea class="form-control" id="inputProblema" placeholder="Descreva o problema" rows="5" autocomplete="off" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer hudRodape">
                    <button onclick="addPergunta()" type="submit" id="postar" class="btn btn-default">Postar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Mostrar Pergunta-->
    <div class="modal fade" id="modal-pergunta" aria-hidden="true" aria-labelledby="exampleModalToggleLabel" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div id="tituloModal" class="modal-header"></div>

                <div id="corpoModal" class="modal-body"></div>

                <div class="modal-footer hudRodape">
                    <div id="botao1">
                        <button onclick="editarModal()" type="submit" id="botao-editar" class="btn btn-default" data-bs-target="#modalEditar" data-bs-toggle="modal">Editar</button>
                    </div>
                    <div id="botao2">
                        <button onclick="apagarPergunta()" type="submit" id="apagar-pergunta" class="btn btn-default" data-bs-dismiss="modal" aria-label="Close">Apagar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Pergunta-->
    <div class="modal fade" id="modalEditar" aria-hidden="true" aria-labelledby="exampleModalToggleLabel2" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header-config">
                    <h5 class="modal-title" id="exampleModalToggleLabel2">Editar Pergunta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body-config">
                    <form id="form-perguntas-modal">
                        <div class="form-group row">
                            <div class="col-sm-6">
                                <label for="inputNomeModal"></label>
                                <input type="text" class="form-control" id="inputNomeModal" placeholder="Nome" required>
                            </div>
                            <div class="col-sm-6">
                                <label for="inputTituloModal"></label>
                                <input type="text" class="form-control" id="inputTituloModal" placeholder="Título da pergunta" autocomplete="off" required>
                            </div>
                        </div>
                        <div class="form_group">
                            <label for="inputProblemaModal"></label>
                            <textarea class="form-control" id="inputProblemaModal" placeholder="Descreva o problema" rows="5" autocomplete="off" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer hudRodape">
                    <button onclick="alterarPergunta()" type="submit" id="confirmar-alteracao" class="btn btn-default">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <header class="cabecalho" id="header">
        <a id="logo" href="#">
            <img src="./SVG/Logo-Klug-2-branco.svg" id="logo-menu" alt="Logo">
            <span id="nomelogo">KLUG </span>
            <span id="localpagina">| Suporte</span>
        </a>
        <nav id="nav">
            <button onclick="toggleMenu()" id="btn-mobile" aria-controls="menu" aria-haspopup="true" aria-label="Abrir Menu"><span id="hamburguer"></span></button></var>
            <ul id="menu" role="menu">
                <li><a href="#">Home</a></li>
                <li><a href="#">Editar rota</a></li>
                <li>
                    <a id="loginProfile" href="#">Entrar</a>
                </li>
            </ul>
        </nav>
    </header>

    <main class="main">
        <div class="row suport">
            <div class="container background-globe">
                <h2 id="titulo">Suporte Klug</span>
                </h2>
                <div class="pesquisa">
                    <form id="barra-pesquisa" class="d-flex" action="" method="submit">
                        <input onclick="filtroPerguntas()" type="text" class="form-control" name="search" id="search" placeholder="Pesquisar" aria-label="Search" list="historico">

                        <button id="searchButton" class="block"><i id="icon_search" class="fas fa-search"></i></button>
                        <button type="button" id="cleanButton" class="hidden"><i id="icon_clean" class="fas fa-times"></i></button>

                        <datalist id="historico"></datalist>
                    </form>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="container conteudo">
                <div class="row instrucoes">
                    <h2>Perguntas da Comunidade</h2>
                    <p id="p1">Tire suas dúvidas aqui</p>
                    <p id="p2">Se você tiver alguma dúvida ainda não respondida, basta escrevê-la e publicá-la</p>
                </div>

                <div class="row perguntas">
                    <div class="titulo_botao">
                        <h3>Perguntas</h3>
                        <button class="botaoAdd trasicao" id="adicionar_mais" type="button" data-bs-toggle="modal" data-bs-target="#adicioner-pergunta"><i id="mais" class="fas fa-plus"></i></button>
                    </div>

                    <div class="area_perguntas">
                        <ul id="conteudo_discussao" class="discussao"></ul>
                    </div>
                </div>
            </div>
        </div>
        <footer class="footer">
            <div class="container">
                <div class="principais-topicos">
                    <h4 class="titulo-rodape"><b>Principais tópicos de ajuda</b></h4>

                    <div class="editar-rotas">
                        <button id="botao-principais-topicos" class="btn btn-default" type="button" data-bs-toggle="collapse" data-bs-target="#edicao-rotas" aria-expanded="false" aria-controls="edicao-rotas">
                            Edição de rotas <span id="icone-dropdonw"><i class="fas fa-chevron-down"></i></span>
                        </button>

                        <div class="collapse" id="edicao-rotas">
                            <div id="texto-expansivo" class="card card-body">
                                O menu de edição de rotas possibilita ao usuário escolher por onde ele deseja passar ou evitar, atualizar o mapa com novas informações; tudo isso em uma interface limpa, intuitiva e fácil de mexer. Para acessá-la basta clicar no ícone de "lápis" no menu
                                inferior
                            </div>
                        </div>
                    </div>

                    <div class="personalizar-rotas">
                        <button id="botao-principais-topicos" class="btn btn-default" type="button" data-bs-toggle="collapse" data-bs-target="#personalizacao-rotas" aria-expanded="false" aria-controls="personalizacao-rotas">
                            Personalizacao de rotas <span id="icone-dropdonw"><i class="fas fa-chevron-down"></i></span>
                        </button>

                        <div class="collapse" id="personalizacao-rotas">
                            <div id="texto-expansivo" class="card card-body">
                                No perfil, o usuário pode escolher qual o tipo de rota desejável para aquele momento, como uma rota mais rápida, segura, que evite as principais avenidas, etc; além de montar um perfil personalizado de preferência de rotas na hora de montar uma. Para
                                criar uma personalização, acesse o perfil e clique em "Criar personalização"
                            </div>
                        </div>
                    </div>

                    <div class="explorar-o-mapa">
                        <button id="botao-principais-topicos" class="btn btn-default" type="button" data-bs-toggle="collapse" data-bs-target="#explorar-mapa" aria-expanded="false" aria-controls="explorar-mapa">
                            Explorar o mapa <span id="icone-dropdonw"><i class="fas fa-chevron-down"></i></span>
                        </button>

                        <div class="collapse" id="explorar-mapa">
                            <div id="texto-expansivo" class="card card-body">
                                Na tela de configurações do mapa, o usuário pode escolher qual tipo de informação aparecerá no mapa como avisos de acidentes, radares, áreas indesejadas ou perigosas, etc...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="final-footer">
                <div class="logo-redes">
                    <div class="logo-footer">
                        <a href="#">
                            <img src="./SVG/Logo-Klug-1-cinza.svg" id="logo-rodape" alt="Logo">
                            <i class="fas fa-chevron-right"></i>
                            <span id="indicador-pagina-rodape">Suporte</span>
                        </a>
                    </div>
                    <div class="redes-footer">
                        <span id="siga-nos">Siga-nos</span>
                        <a class="facebook" href="https://web.facebook.com/" target="_blank"><i class="fab fa-facebook-square"></i></a>
                        <a class="twitter" href="https://twitter.com/home" target="_blank"><i class="fab fa-twitter"></i></a>
                        <a class="instagram" href="https://www.instagram.com/" target="_blank"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>

                <hr id="linha-footer">

                <div class="copyright">
                    <div class="copyright-texto">
                        <h5><b>Copyright&copy <span id="ano"></span> Klug </b>| Todos os direitos reservados</h5>
                    </div>
                    <div class="pais">
                        <h5>Brasil</h5>
                    </div>
                </div>
            </div>
        </footer>
    </main>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
</body>

</html>
